- include: ../pythonenv/setup.yml
  vars:
    python_project_root: "{{ django_project_root }}"
    python_user: "{{ django_user }}"
    python_repo_path: "{{ django_repo_path }}"
    python_logs_path: "{{ django_logs_path }}"
    python_env_path: "{{ django_env_path }}"
    python_env_variables: django_env_variables
    python_app_name: "{{ django_project_name }}"
    python_source_paths: "{{ django_source_paths }}"


- name: Create static files directory.
  file: path={{django_static_path}} owner={{django_user}} group={{django_user}} recurse=yes state=directory mode=0777
  sudo: yes

- name: Configure nginx
  template: src=../django/templates/nginx_site dest=/etc/nginx/sites-enabled/{{django_project_name}}
  sudo: yes
  notify:
    - restart nginx

- name: Configure uwsgi service
  supervised:
    name: "uwsgi-{{django_project_name}}"
    command: '{{django_env_path}}/bin/uwsgi --chdir {{django_app_path}}  --wsgi-file {{django_wsgi_script}} --master --processes 4 --threads 2 --socket 127.0.0.1:{{django_uwsgi_port}}'
    autorestart: true
    stdout_logfile: '{{django_logs_path}}/uwsgi-out.log'
    stderr_logfile: '{{django_logs_path}}/uwsgi-err.log'
    user: '{{django_user}}'
    directory: '{{django_app_path}}'
    environment:
      DJANGO_SETTINGS_MODULE: '{{django_settings_module}}'

  sudo: yes
  notify:
    - restart nginx
    - start supervisord
    - restart supervisord tasks
